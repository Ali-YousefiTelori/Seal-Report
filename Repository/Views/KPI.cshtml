@using Seal.Model
@using Seal.Helpers
<div class="text-center" style="width:250px">
    @{
        Report report = Model;
        ReportView view = report.CurrentView;
        ReportView modelView = report.CurrentModelView;
        ReportModel reportModel = modelView.Model;
        ResultPage page = report.CurrentPage;
        ResultTable table = page.DataTable;

        bool trendDirection = view.GetBoolValue("kpi_trend_direction");
        int trendValues = view.GetNumericValue("kpi_trend_values");
        string buttonSize = view.GetValue("kpi_size");
        string goalSuffix = "_GOAL";
    }
    @{
        //Calculate trend
        int trend = 0;
        string headerValue = "", lastValue = "", trendPercentage = "", trendColor = "primary", trendIcon = "option-horizontal";
        for (int col = 0; col < table.ColumnCount; col++)
        {
            var lastCell = table[table.BodyEndRow - 1, col];
            if (table.BodyStartRow == table.BodyEndRow)
            {
                lastCell = table[table.BodyEndRow, col]; //Case only one value
            }
            if (lastCell.Element != null && lastCell.Element.IsNumeric && !lastCell.IsTotal && lastCell.Element.PivotPosition == PivotPosition.Data && lastCell.Value != null && !lastCell.Element.DisplayNameEl.EndsWith(goalSuffix))
            {
                if (table.BodyStartRow == 0) { headerValue = lastCell.Element.DisplayNameElTranslated; }
                else if (table.BodyStartRow == 1 || (table.BodyStartRow == 2 && !reportModel.ShowFirstLine)) { headerValue = table[0, col].HTMLValue; }
                else { headerValue = table[1, col].HTMLValue; }

                lastValue = lastCell.HTMLValue;
                var valueEnd = lastCell.DoubleValue;

                double? valueStart = null;
                int rowStart = table.BodyEndRow - 2;
                while (rowStart >= table.BodyStartRow && (trendValues < 0 || trendValues + 1 >= table.BodyEndRow - rowStart || valueStart == null))
                {
                    if (table[rowStart, col].Value != null) { valueStart = table[rowStart, col].DoubleValue; }
                    --rowStart;
                }

                if (valueStart != null && valueStart != valueEnd)
                {
                    trend = (valueStart < valueEnd ? 1 : -1);
                    trendIcon = (trend == 1 ? "export" : "import");
                    if (!trendDirection) { trend = -1 * trend; }
                    trendColor = (trend == 1 ? "success" : "danger");
                }
                if (valueStart != null && valueStart != 0) { trendPercentage = string.Format("{0:+0;-0;0} %", 100 * (valueEnd - valueStart) / valueStart); }

                //Check if a Goal is defined
                string goalValue = "", goalColor = "default", goalPercentage = "", goalIcon = "";
                for (int colGoal = 0; colGoal < table.ColumnCount; colGoal++)
                {
                    var goalCell = table[table.BodyEndRow - 1, colGoal];
                    if (goalCell.Element != null && goalCell.Element.DisplayNameEl == lastCell.Element.DisplayNameEl + goalSuffix && goalCell.Element.IsNumeric && goalCell.Value != null)
                    {
                        goalValue = string.Format("{0}: {1}", report.Translate("Goal"), goalCell.HTMLValue);
                        int goal = (goalCell.DoubleValue <= valueEnd ? 1 : -1);
                        if (!trendDirection) { trend = -1 * trend; }
                        goalIcon = (goal == 1 ? "ok" : "circle-arrow-down");
                        goalColor = (goal == 1 ? "success" : "danger");

                        if (goalCell.DoubleValue != 0) { goalPercentage = string.Format("({0:+0;-0;0} %)", 100 * (valueEnd - goalCell.DoubleValue) / goalCell.DoubleValue); }
                    }
                }

                if (!string.IsNullOrEmpty(trendPercentage))
                {
                    <span class="text-center btn btn-@trendColor @buttonSize" title="@Raw(headerValue)" style="margin-top:5px;">
                        <span class="glyphicon glyphicon-@trendIcon" aria-hidden="true"></span> @Raw(headerValue) <strong>@Raw(lastValue)</strong>
                        <span class="badge">@Raw(trendPercentage)</span>
                    </span>
                }
                else
                {
                    <span class="text-center btn btn-@trendColor @buttonSize" title="@Raw(headerValue)" style="margin-top:5px;">
                        @Raw(headerValue) <strong>@Raw(lastValue)</strong>
                    </span>
                }


                if (!string.IsNullOrEmpty(goalValue))
                {
                    <span class="text-center label label-@goalColor @buttonSize" title="@Raw(headerValue)" style="margin-top:0px;font-size: 12px;">
                        <span class="glyphicon glyphicon-@goalIcon" aria-hidden="true"></span> @Raw(goalValue) @Raw(goalPercentage)
                    </span>
                }
            }
        }
    }
</div>